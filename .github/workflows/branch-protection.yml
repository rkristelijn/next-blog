name: Branch Protection Check

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run diagnostics
        run: npm run diagnose

      - name: Validate posts data generation
        run: |
          echo "ğŸ”„ Testing posts data generation..."
          node scripts/generate-posts-data.js
          echo "âœ… Posts data generation successful!"

      - name: Run linting
        run: npm run lint

      - name: Test build process
        run: npm run ci:build

      - name: Check for required files
        run: |
          echo "ğŸ” Checking required files..."
          test -f "src/data/posts.json" || (echo "âŒ posts.json not generated" && exit 1)
          test -f ".github/workflows/deploy.yml" || (echo "âŒ deploy.yml missing" && exit 1)
          test -f "wrangler.jsonc" || (echo "âŒ wrangler.jsonc missing" && exit 1)
          echo "âœ… All required files present"

  check-documentation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation consistency
        run: |
          echo "ğŸ“š Checking documentation..."
          
          # Check if new posts have proper frontmatter
          for file in src/content/posts/*.mdx; do
            if ! grep -q "^title:" "$file"; then
              echo "âŒ Missing title in $file"
              exit 1
            fi
            if ! grep -q "^date:" "$file"; then
              echo "âŒ Missing date in $file"
              exit 1
            fi
            if ! grep -q "^excerpt:" "$file"; then
              echo "âŒ Missing excerpt in $file"
              exit 1
            fi
          done
          
          echo "âœ… All posts have required frontmatter"

  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for sensitive data
        run: |
          echo "ğŸ”’ Checking for sensitive data..."
          
          # Check for potential secrets in code
          if grep -r "CLOUDFLARE_API_TOKEN.*=" src/ || grep -r "api_token.*=" src/; then
            echo "âŒ Potential API token found in source code"
            exit 1
          fi
          
          # Check for hardcoded secrets
          if grep -r "sk-" src/ || grep -r "pk_" src/; then
            echo "âŒ Potential hardcoded secret found"
            exit 1
          fi
          
          echo "âœ… No sensitive data detected"
